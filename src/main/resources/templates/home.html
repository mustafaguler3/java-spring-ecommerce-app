<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorate="~{layout.html}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>


    <link rel="stylesheet" th:href="@{/css/home.css}" />


    <title>Product Listing</title>

    <style>
        .brand-list {
            display: flex;
            flex-direction: column;
        }
        .brand-list .brand-item {
            margin-bottom: 10px;
        }


    </style>

</head>
<body layout:fragment="mainContent">

<div th:if="${message}">
    <h5 th:text="${message}"></h5>
</div>


    <div class="container my-3">
        <div class="row g-3 g-lg-4">
            <div class="col-lg-3 my-2">
                <div class="sidebar my-2">


                    <div class="card my-4">
                        <article class="card-group-item">
                            <header class="card-header">
                                <h6 class="title">Category</h6>
                            </header>
                            <div class="filter-content">
                                <div class="list-group list-group-flush" th:each="category:${categories}">
                                    <a href="#" class="list-group-item" th:text="${category.name}">
                                        <span class="float-right badge badge-light round"
                                              th:each="entry : ${categoryProductCount.entrySet()}">
                                        <p th:text="${entry.value}"></p>
                                        </span>
                                    </a>


                                </div>  <!-- list-group .// -->
                            </div>
                        </article> <!-- card-group-item.// -->


                    </div> <!-- card.// -->

                    <div class="card my-2">
                        <article class="card-group-item">
                            <header class="card-header">
                                <h6 class="title">Range input </h6>
                            </header>
                            <div class="filter-content">
                                <div class="card-body">
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label>Min</label>
                                            <input type="number" class="form-control" id="inputEmail4" placeholder="$0">
                                        </div>
                                        <div class="form-group col-md-6 text-right">
                                            <label>Max</label>
                                            <input type="number" class="form-control" placeholder="$1,0000">
                                        </div>
                                    </div>
                                </div> <!-- card-body.// -->
                            </div>
                        </article> <!-- card-group-item.// -->
                    </div>

                    <div class="card my-2">
                        <article class="card-group-item">
                            <header class="card-header">
                                <h6 class="title">Brand</h6>
                            </header>
                            <div class="filter-content">
                                <div class="card-body" >

                                    <div class="brand-list">
                                        <div th:each="brand : ${brandCountMap.entrySet()}" class="brand-item">
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input" th:id="'Check' + ${brand}">
                                                <label class="custom-control-label"
                                                       th:for="'Check' + ${brand}" th:text="${brand.key}"></label>
                                                <span class="float-right badge badge-light round"
                                                          th:text="${brand.value}"></span>
                                            </div>
                                        </div>

                                    </div>
                                </div> <!-- card-body.// -->
                            </div>
                        </article> <!-- card-group-item.// -->
                    </div>

                </div>
            </div>
            <!-- Product Box -->
                <div class="col-lg-9">
                    <div class="row">
                        <div class="col-6 col-lg-4 my-2" th:each="product: ${products}">
                            <div class="product-card-10">
                                <div class="product-card-image">
                                    <div class="badge-ribbon"><span class="badge badge-sm">Sale</span></div>
                                    <div class="product-media">
                                        <a th:href="@{/products/{productId}(productId=${product.id})}">
                                        <img class="img-fluid"
                                             style="width:380px; height:380px"
                                             th:src="@{/uploads/products/{fileName}(fileName=${product.imageUrlShow})}"
                                             title="" alt="">
                                        </a>
                                    </div>
                                </div>
                                <div class="product-card-info">

                                    <h6 class="product-title"><a href="#" th:text="${product.name}">Full Rim Aviator Eyeglasses</a></h6>
                                    <div class="product-price"><span class="text-primary" th:text="${product.price}">$28.<small>50</small></span> <del class="fs-sm text-muted">$38.<small>50</small></del></div>
                                    <div class="d-flex mt-3 justify-content-center">
                                        <div class="stars-outer">
                                            <div class="stars-inner"
                                                 th:style="'width:' + (${product.averageRating} / 5.0 * 100) + '%'"></div>
                                        </div>

                                        <span th:text="${#numbers.formatDecimal(product.averageRating, 1, 1)}"></span>
                                    </div>
                                    <div class="product-action">

                                        <a class="wishlist-button btn action-btn" th:attr="data-product-id=${product.id}"
                                           th:classappend="${product.inWishlist} ? 'active' : ''">
                                            <i class="fa fa-heart" th:classappend="${product.inWishlist} ? 'text-danger' : ''"></i>
                                        </a>

                                        <a href="#" class="btn action-btn">
                                            <i class="fa fa-repeat">

                                            </i>
                                        </a>
                                        <a
                                           th:href="@{/products/{productId}(productId=${product.id})}" class="btn action-btn">
                                            <i class="fa fa-eye"></i>
                                        </a>

                                        <form
                                                class="btn action-btn" th:action="@{/cart/add/{id}(id=${product.id})}" method="post">
                                            <button class="btn action-btn" id="addToCartBtn" th:onclick="|addToCart(${product.id})|">
                                                <i class="fa fa-shopping-cart">

                                                </i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        </div>


        <div class="d-flex justify-content-center">
            <nav aria-label="Page navigation example">
                <ul class="pagination">
                    <li class="page-item" th:if="${currentPage > 0}">
                        <a class="page-link" th:href="@{/home(page=${currentPage - 1})}">Previous</a>
                    </li>
                    <li class="page-item" th:each="i : ${#numbers.sequence(0,totalPages - 1)}">
                        <a class="page-link" th:href="@{/home(page=${i})}"
                           th:text="${i + 1}"
                           th:classappend="${i == currentPage} ? 'active' : ''"></a>
                    </li>
                    <li class="page-item" th:if="${currentPage < totalPages - 1}">
                        <a class="page-link" th:href="@{/home(page=${currentPage + 1})}">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>





<script>
    $(document).ready(function() {
        $('.wishlist-button').click(function(event) {
            event.preventDefault();
            var $button = $(this);
            var productId = $button.data('product-id');
            var isInWishlist = $button.find('.fa-heart').hasClass('red');
            if (isInWishlist) {
                // Remove from wishlist
                $.ajax({
                    url: "/wishlist/remove/" + productId,
                    type: 'DELETE',
                    success: function(data) {
                        alert(data.message);
                        $button.find('.fa-heart').removeClass('red');
                        $button.removeClass('active');
                        $button.data('inWishlist', false);
                    },
                    error: function(xhr, status, error) {
                        alert("Error: " + xhr.responseText);
                    }
                });
            } else {
                // Add to wishlist
                $.post("/wishlist/add/" + productId)
                    .done(function(data) {
                        alert(data.message);
                        $button.find('.fa-heart').addClass('red');
                        $button.addClass('active');
                        $button.data('inWishlist', true);
                    })
                    .fail(function(xhr, status, error) {
                        alert("Error: " + xhr.responseText);
                    });
            }
        });
    });


   function addToCart(productId) {
        fetch(`/cart/add/${productId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
            }
        }).then(response => response.text())
          .then(message => {
              if (message.includes("Ürün sepete eklendi")) {
                  showToast("Ürün sepete eklendi", 'success');
              } else {
                  showToast("Ürün sepete eklenemedi", 'error');
              }
          })
          .catch(error => {
              showToast("Bir hata oluştu", 'error');
          });
    }

    function showToast(message, type) {
        Toastify({
            text: message,
            className: type === 'success' ? 'success' : 'error',
            style: {
                background: type === 'success' ? "linear-gradient(to right, #00b09b, #96c93d)" : "linear-gradient(to right, #ff416c, #ff4b2b)"
            }
        }).showToast();
    }

</script>

<script th:inline="javascript">
    /*<![CDATA[*/
    var message = /*[[${message}]]*/ '';
    if (message) {
        Toastify({
            text: message,
            className: 'info',
            style: {
                background: 'linear-gradient(to right, #00b09b, #96c93d)'
            }
        }).showToast();
    }
    /*]]>*/
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<!-- jQuery library -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
</body>
</html>